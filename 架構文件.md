# Sunneo/libs 架構文件 (Architecture Documentation)

## 專案概述 (Project Overview)

這是一個用 C 語言實作的綜合性資料結構與演算法函式庫集合，由 Sunneo IceCold 開發維護。本專案包含多種常用資料結構的實作，從基礎的線性結構（List、Stack、Queue）到複雜的樹狀結構（B+ Tree、Red-Black Tree），以及各種實用工具模組（Socket、BMP 圖像處理、協程等）。

**授權方式**: BSD 3-Clause License  
**程式語言**: C  
**建置工具**: Make / GCC

---

## 整體架構 (Overall Architecture)

本專案採用模組化設計，每個模組都是獨立的函式庫，可單獨編譯和使用。所有模組遵循以下統一架構：

```
Module/
├── include/          # 標頭檔 (.h)
├── src/             # 原始碼 (.c)
├── bin/             # 編譯後的執行檔
├── obj/             # 中間目標檔
├── lib/             # 依賴的其他函式庫
├── test/            # 測試程式
└── Makefile         # 建置腳本
```

---

## 核心模組清單 (Core Modules)

### 1. 線性資料結構 (Linear Data Structures)

#### 1.1 List (雙向鏈結串列)
- **路徑**: `/List/`
- **標頭檔**: `include/list.h`
- **功能描述**: 
  - 實作雙向鏈結串列（Doubly Linked List）
  - 支援前後端插入/刪除操作
  - 提供迭代器介面遍歷元素
  - 支援自訂相等比較函式

**主要 API**:
```c
List* list_create(unsigned int elesize, EqualCompare eql);
void list_push_back(List* list, const void* data);
void list_push_front(List* list, const void* data);
void* list_find_first(List* list, const void* data);
ListIter list_get_iter(const List* list);
```

#### 1.2 Vector (動態陣列)
- **路徑**: `/Vector/`
- **標頭檔**: `include/vector.h`
- **功能描述**:
  - 動態大小的陣列實作
  - 支援前後端插入/刪除
  - 自動擴充容量
  - 支援元素或指標儲存模式
  - 可設定元素析構函式

**主要 API**:
```c
Vector* vector_create(int elesize);
void vector_push_back(Vector* a, const void* data);
void* vector_at(const Vector* a, int idx);
void vector_insert(Vector* a, int idx, const void* data);
```

#### 1.3 Stack (堆疊)
- **路徑**: `/Stack/`
- **標頭檔**: `include/stack.h`
- **功能描述**:
  - LIFO (Last In First Out) 資料結構
  - 基於動態陣列實作

#### 1.4 Queue (佇列)
- **路徑**: `/Queue/`
- **標頭檔**: `include/queue.h`
- **功能描述**:
  - FIFO (First In First Out) 資料結構
  - 支援環形緩衝區實作

---

### 2. 樹狀資料結構 (Tree Data Structures)

#### 2.1 BinTree (二元搜尋樹)
- **路徑**: `/BinTree/`
- **標頭檔**: `include/bst.h`, `include/bstiter.h`
- **功能描述**:
  - 實作二元搜尋樹 (Binary Search Tree)
  - 支援插入、刪除、搜尋操作
  - 提供迭代器進行樹遍歷
  - 支援前序、中序、後序遍歷

**主要操作**:
- 插入節點
- 刪除節點
- 搜尋元素
- 尋找最小/最大值
- 樹遍歷

#### 2.2 RBTree (紅黑樹)
- **路徑**: `/RBTree/`
- **標頭檔**: `include/rbtree.h`
- **功能描述**:
  - 自平衡二元搜尋樹
  - 保證 O(log n) 的操作時間複雜度
  - 支援 BFS、DFS 遍歷
  - 支援前序、中序、後序遍歷

**主要 API**:
```c
RBTree* rbtree_create(int elesize, int keysize, int(*cmp)(const void*, const void*));
void rbtree_insert(RBTree* rbtree, const void* key, const void* value);
void* rbtree_search(const RBTree* rbtree, const void* key);
void rbtree_erase(RBTree* rbtree, const void* key);
```

#### 2.3 B+ Tree
- **路徑**: `/btree/`
- **標頭檔**: `bpt.h`
- **功能描述**:
  - B+ 樹實作，適合資料庫索引
  - 所有資料儲存在葉節點
  - 葉節點之間有鏈結
  - 支援範圍查詢

**特色**:
- 基於 Amittai Aviram 的實作修改
- 支援自訂比較函式
- 高效的範圍查詢能力

---

### 3. 雜湊資料結構 (Hash-based Data Structures)

#### 3.1 HashMap (雜湊映射表)
- **路徑**: `/HashMap/`
- **標頭檔**: `include/hashmap.h`
- **功能描述**:
  - Key-Value 映射資料結構
  - 支援自訂雜湊函式
  - 支援自訂鍵值相等比較函式

**主要 API**:
```c
struct HashMap* hashmap_new(int (*hashfnc)(const void*), int (*keyEQL)(const void*, const void*));
void hashmap_put(struct HashMap* tbl, const void* key, const void* value);
void* hashmap_get(const struct HashMap* tbl, const void* key);
void* hashmap_remove(struct HashMap* tbl, const void* key);
int hashmap_contains_key(const struct HashMap* tbl, const void* key);
```

#### 3.2 Hashtable (雜湊表)
- **路徑**: `/Hashtable/`, `/Hashtable.2/`
- **標頭檔**: `include/hashtable.h`
- **功能描述**:
  - 基本雜湊表實作
  - 兩個版本提供不同實作方式

#### 3.3 Hash (雜湊函式集合)
- **路徑**: `/Hash/`
- **功能描述**:
  - 提供各種常用雜湊函式
  - 可用於 HashMap 和 Hashtable

---

### 4. 堆積資料結構 (Heap Data Structures)

#### 4.1 Heap
- **路徑**: `/Heap/heap_nr/heapNr_c/`
- **標頭檔**: `include/heap_nr.h`
- **功能描述**:
  - 優先佇列實作
  - 支援最小堆/最大堆
  - 常用於排序和優先級處理

---

### 5. 組合數學模組 (Combinatorial Modules)

#### 5.1 Permutation (排列生成器)
- **路徑**: `/Permutation/`
- **標頭檔**: `include/permutation.h`, `include/iter.h`
- **功能描述**:
  - 生成集合的所有排列組合
  - 提供迭代器介面
  - 支援陣列迭代器

**應用場景**:
- 排列組合問題
- 回溯演算法
- 暴力搜尋優化

#### 5.2 Powerset (冪集生成器)
- **路徑**: `/Powerset/`
- **標頭檔**: `include/powerset.h`
- **功能描述**:
  - 生成集合的所有子集（冪集）
  - 提供迭代器介面

**應用場景**:
- 子集枚舉問題
- 動態規劃
- 組合優化

---

### 6. 字串處理模組 (String Processing)

#### 6.1 String (動態字串)
- **路徑**: `/String/`
- **標頭檔**: `cstring.h`
- **功能描述**:
  - 動態字串實作
  - 支援字串連接、格式化
  - 自動記憶體管理

**主要 API**:
```c
String* string_create(const char* str);
String* string_append(String* dst, const String* src);
String* string_append_format(String* dst, const char* fmt, ...);
char* string_findfirst(const String* str, int idx_token, const char* token);
```

#### 6.2 StringTokenizer (字串分割器)
- **路徑**: `/StringTokenizer/`
- **功能描述**:
  - 字串分割與解析
  - Token 化處理

---

### 7. 網路通訊模組 (Network Communication)

#### 7.1 Socket (網路套接字)
- **路徑**: `/Socket/`
- **子模組**:
  - **TCP** (`tcp/`): TCP 協定封裝
    - `tcp_sck.h`: TCP 伺服器/客戶端實作
    - 範例: `factor_client.c`, `factor_server.c`
  - **UDP** (`udp/`): UDP 協定封裝
    - `udp_sck.h`: UDP 通訊實作
  - **Unix Domain Socket** (`unix/`): Unix 本地套接字
    - `unix_sck.h`: Unix domain socket 實作
  - **Wrapper** (`wrap/`): 高階封裝

**功能描述**:
- 跨平台網路程式設計介面
- 簡化 Socket 程式設計
- 支援 TCP、UDP、Unix Domain Socket

---

### 8. 圖像處理模組 (Image Processing)

#### 8.1 BMP (點陣圖處理)
- **路徑**: `/BMP/`
- **標頭檔**: `include/bmp.h`
- **功能描述**:
  - BMP 圖檔讀寫
  - 基本繪圖功能（點、線、矩形、圓形）
  - 像素操作
  - 填充功能

**主要 API**:
```c
BMP* bmp_create(ulong width, ulong height, ulong bkclr);
BMP* bmp_create_from_file(const char* name);
void bmp_point(BMP* bmp, long x, long y, ulong clr);
void bmp_line(BMP* bmp, long x1, long y1, long x2, long y2, ulong clr);
void bmp_rect(BMP* bmp, long x1, long y1, ulong w, ulong h, ulong clr);
void bmp_circle(BMP* bmp, long x, long y, ulong radix, double wR, double hR, ulong clr);
void bmp_write(const BMP* bmp, const char* name);
```

---

### 9. 並行處理模組 (Concurrency)

#### 9.1 Coroutine (協程)
- **路徑**: `/coroutine/`
- **實作方式**:
  - **ucontext** (`ucontext/`): 基於 POSIX ucontext 實作
  - **jmpbuf** (`jmpbuf/`): 基於 setjmp/longjmp 實作

**標頭檔**: `coroutine.h`

**功能描述**:
- 輕量級協程（Fiber）實作
- 支援協程創建、恢復、掛起
- 支援多種資料型態的 yield 值
- 提供父子協程關係管理

**主要 API**:
```c
Fiber* fiber_create(void(*fnc)(void*), void* parm);
void fiber_start(Fiber* fiber);
void fiber_resume(Fiber* fiber);
void fiber_yield(FiberYieldValue v);
int fiber_terminated(Fiber* fiber);
```

**Yield 支援的資料型態**:
- 整數型態 (int, short, long, long long)
- 浮點數 (float, double)
- 指標 (void*)
- 各種無符號整數型態

---

### 10. 工具模組 (Utility Modules)

#### 10.1 File Utilities (檔案工具)
- **路徑**: `/utils/File/`
- **標頭檔**: `fileutil.h`
- **功能描述**:
  - 檔案操作封裝
  - 檔案資訊查詢
  - 目錄操作

**主要 API**:
```c
off_t file_size(const char* filepath);
int file_exists(const char* filepath);
int file_isdir(const char* filepath);
int file_makedir(const char* fpath);
time_t file_mtime(const char* fpath);
int file_write(const char* fpath, const void* byte, size_t len);
int file_read(const char* fpath, void* inbyte, size_t len);
void file_list(const char* path, void(*entry_fnc)(const char*), int onlydir);
```

#### 10.2 Config Parser (配置檔解析器)
- **路徑**: `/utils/Config/`
- **標頭檔**: `conf.h`
- **功能描述**:
  - 配置檔讀取與解析
  - Key-Value 配置管理

---

### 11. 巨集模組 (Macro Templates)

#### 11.1 Macro (泛型資料結構巨集)
- **路徑**: `/Macro/`
- **功能描述**:
  - 提供泛型資料結構的巨集實作
  - 類似 C++ Template 的功能

**包含的巨集資料結構**:
- **macro_array.h**: 動態陣列巨集
- **macro_list.h**: 鏈結串列巨集
- **macro_stack.h**: 堆疊巨集
- **macro_queue.h**: 佇列巨集
- **macro_deque.h**: 雙端佇列巨集

**使用方式**:
```c
// 定義 int 類型的陣列
ArrayDefine(int)
ArrayDeclare(int)

// 使用
int_Array* arr;
ArrayCreate(arr);
ArrayPushBack(arr, 42);
ArrayDestroy(arr);
```

---

## 模組相依關係 (Module Dependencies)

### 內部相依關係

某些模組內部有相依關係，例如：

1. **BMP 模組** 依賴於：
   - Queue (內建在 `BMP/lib/Queue/`)

2. **BinTree 模組** 依賴於：
   - Stack (內建在 `BinTree/lib/Stack/`)

3. **HashMap 模組** 可能依賴於：
   - BinTree (用於衝突解決)

### 外部相依關係

- **標準 C 函式庫**: 所有模組
- **POSIX API**: Socket、Coroutine (ucontext)
- **pthread** (部分模組): btree 的 pth 版本

---

## 設計模式與最佳實踐 (Design Patterns and Best Practices)

### 1. 介面設計原則

所有模組遵循以下設計原則：

- **一致的命名規範**: `模組名_動作(參數...)`
  - 例如: `list_create()`, `vector_push_back()`, `hashmap_get()`

- **明確的生命週期管理**:
  - `xxx_create()`: 創建並初始化
  - `xxx_delete()`: 釋放資源
  - `xxx_clear()`: 清空內容但保留結構

- **返回值慣例**:
  - 指標型返回: 失敗返回 `NULL`
  - 整數型返回: 成功返回 0 或正值，失敗返回負值或 0

### 2. 記憶體管理

- 所有資料結構採用**動態記憶體配置**
- 使用者需要明確呼叫 `xxx_delete()` 釋放資源
- 支援**深拷貝**語意（依元素大小配置）
- 提供**自訂析構函式**選項（如 Vector 的 `pop_function`）

### 3. 泛型設計

雖然 C 語言沒有原生泛型支援，本專案採用兩種方式實現泛型：

1. **void* 指標** + **元素大小參數**:
   ```c
   List* list_create(unsigned int elesize, EqualCompare eql);
   ```

2. **C 預處理器巨集** (Macro 模組):
   ```c
   ArrayDefine(TYPE)
   ```

### 4. 函式指標應用

廣泛使用函式指標實現：
- **自訂比較函式**: `int (*compare)(const void*, const void*)`
- **自訂雜湊函式**: `int (*hashfnc)(const void*)`
- **自訂回呼函式**: `void (*callback)(void*)`

### 5. 迭代器模式

多數容器提供迭代器介面：
```c
ListIter iter = list_get_iter(list);
while (list_iter_hasNext(iter)) {
    void* data = list_iter_next(iter);
    // 處理資料
}
list_iter_delete(iter);
```

---

## 建置系統 (Build System)

### Makefile 結構

每個模組都有獨立的 Makefile，通常包含以下目標：

- **all**: 建置靜態函式庫 (`.a`)
- **test**: 建置並執行測試程式
- **clean**: 清除編譯產物
- **remake**: 清除後重新建置

### 編譯選項

```makefile
CC = gcc
CFLAGS = -ansi -fexpensive-optimizations -O3
```

### 輸出檔案

- **靜態函式庫**: `bin/*.a`
- **執行檔**: `bin/*Demo` 或 `bin/*`
- **目標檔**: `obj/*.o`

---

## 效能特性 (Performance Characteristics)

| 資料結構 | 插入 | 刪除 | 搜尋 | 空間複雜度 |
|---------|------|------|------|-----------|
| List    | O(1) | O(n) | O(n) | O(n)      |
| Vector  | O(1)* | O(n) | O(1) | O(n)      |
| Stack   | O(1) | O(1) | -    | O(n)      |
| Queue   | O(1) | O(1) | -    | O(n)      |
| HashMap | O(1)* | O(1)* | O(1)* | O(n)    |
| RBTree  | O(log n) | O(log n) | O(log n) | O(n) |
| B+ Tree | O(log n) | O(log n) | O(log n) | O(n) |
| Heap    | O(log n) | O(log n) | O(n) | O(n) |

*註: 平均情況；Vector 的 push_back 在需要擴容時為 O(n)；HashMap 在雜湊衝突時退化。

---

## 執行緒安全性 (Thread Safety)

⚠️ **重要**: 本函式庫的大部分模組**不是執行緒安全的**。

- 在多執行緒環境中使用時，需要自行加入互斥鎖（mutex）保護
- B+ Tree 有提供 pthread 版本 (`bpt_pth.c`)，但需要單獨編譯

---

## 可移植性 (Portability)

### 支援平台

- **Linux**: 完全支援
- **Unix-like系統**: 完全支援
- **Windows**: 部分支援（需要 MinGW 或 Cygwin）

### 編譯器需求

- **GCC**: 主要測試編譯器
- **Clang**: 應該相容
- **MSVC**: 需要修改（使用 Windows API）

### 標準相容性

- 主要遵循 **ANSI C (C89)** 標準
- 部分模組使用 **POSIX** 擴充（Socket、Coroutine）

---

## 擴充與客製化 (Extension and Customization)

### 如何新增自訂資料型態

1. **使用 void* 介面**:
```c
typedef struct {
    int id;
    char name[32];
} MyData;

List* list = list_create(sizeof(MyData), my_compare_func);
MyData data = {1, "test"};
list_push_back(list, &data);
```

2. **使用 Macro 模組**:
```c
ArrayDefine(MyData)
ArrayDeclare(MyData)

MyData_Array* arr;
ArrayCreate(arr);
// 使用...
```

### 如何客製化比較函式

```c
int my_compare(const void* a, const void* b) {
    int* ia = (int*)a;
    int* ib = (int*)b;
    return (*ia > *ib) - (*ia < *ib);
}

RBTree* tree = rbtree_create(sizeof(int), sizeof(int), my_compare);
```

---

## 測試與驗證 (Testing and Validation)

大部分模組都包含測試程式：

- 測試檔案通常位於 `test/` 或 `src/main.c`
- 執行 `make test` 可以建置並執行測試
- 測試涵蓋基本功能驗證

---

## 已知限制 (Known Limitations)

1. **記憶體管理**: 需要手動管理，無垃圾回收
2. **執行緒安全**: 預設不提供執行緒安全保證
3. **錯誤處理**: 部分函式缺乏完整的錯誤檢查
4. **文件**: 部分模組缺少詳細的使用文件
5. **單元測試**: 測試覆蓋率不完整

---

## 未來發展方向 (Future Directions)

1. 增加單元測試覆蓋率
2. 提供更完整的錯誤處理機制
3. 增加更多的演算法實作
4. 改善文件和範例程式
5. 支援更多平台
6. 提供執行緒安全版本

---

## 貢獻指南 (Contribution Guidelines)

1. 遵循現有的程式碼風格
2. 為新功能添加測試
3. 更新相關文件
4. 確保在主要平台上編譯通過

---

## 版權與授權 (Copyright and License)

Copyright 2024, Sunneo IceCold

本專案採用 **BSD 3-Clause License** 授權。詳見 `LICENSE` 檔案。

---

## 參考資料 (References)

- B+ Tree 實作參考: Amittai Aviram 的 B+ Tree ([www.amittai.com/prose/bplustree.html](http://www.amittai.com/prose/bplustree.html))
- Red-Black Tree 演算法: 標準演算法教科書
- 資料結構理論: 計算機科學經典教材

---

## 附錄：快速參考表 (Quick Reference)

### 容器選擇指南

| 需求 | 推薦容器 | 理由 |
|-----|---------|------|
| 隨機存取 | Vector | O(1) 索引存取 |
| 頻繁插入刪除 | List | O(1) 前後端操作 |
| LIFO 操作 | Stack | 專用堆疊結構 |
| FIFO 操作 | Queue | 專用佇列結構 |
| Key-Value 查詢 | HashMap | O(1) 平均查詢 |
| 有序資料 | RBTree | 自動排序，O(log n) 操作 |
| 大量資料 | B+ Tree | 適合磁碟儲存，範圍查詢佳 |
| 優先級處理 | Heap | O(log n) 插入/彈出最小值 |

### 模組檔案快速索引

```
資料結構: List, Vector, Stack, Queue, Deque
樹結構: BinTree, RBTree, btree (B+ Tree)
雜湊結構: HashMap, Hashtable, Hash
堆積: Heap
字串: String, StringTokenizer
演算法: Permutation, Powerset
網路: Socket (TCP/UDP/Unix)
圖像: BMP
並行: coroutine
工具: utils (File, Config)
泛型: Macro (各種巨集模板)
```

---

**文件版本**: 1.0  
**最後更新**: 2024-01-18  
**維護者**: Sunneo IceCold
